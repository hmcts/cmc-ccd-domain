version: 1.0-preview-1
steps:

  - id: pull-base
    cmd: docker pull {{.Run.Registry}}/hmcts/cmc-ccd-definition-importer/base:latest || true
    when: ["-"]
    keep: true

  - id: base
    build: >
      -t {{.Run.Registry}}/hmcts/cmc-ccd-definition-importer/base
      --cache-from {{.Run.Registry}}/hmcts/cmc-ccd-definition-importer/base:latest
      --target base
      -f ./definition/Dockerfile
      .
    when:
      - pull-base
    keep: true

  - id: release
    build: >
      -t {{.Run.Registry}}/hmcts/cmc-ccd-definition-importer:{{.Values.TAG}} 
      -t {{.Run.Registry}}/hmcts/cmc-ccd-definition-importer:test 
      -t {{.Run.Registry}}/hmcts/cmc-ccd-definition-importer:{{.Run.ID}}
      --cache-from {{.Run.Registry}}/hmcts/cmc-ccd-definition-importer/base:latest
      --target runtime
      -f ./definition/Dockerfile
      .
    when:
      - base
    keep: true

  - id: test
    cmd: {{.Run.Registry}}/hmcts/cmc-ccd-definition-importer:{{.Run.ID}} sh -c "cd /opt/ccd-definition-processor && yarn json2xlsx -D /data/sheets -o /cmc-ccd.xlsx"
    env: 
      - CCD_DEF_BASE_URL=http://localhost
      - CCD_DEF_CLAIM_STORE_BASE_URL=http://claim-store-api:4400
    when:
      - release
    
  - id: push-images
    push:
      - "{{.Run.Registry}}/hmcts/cmc-ccd-definition-importer/base:latest"
      - "{{.Run.Registry}}/hmcts/cmc-ccd-definition-importer:{{.Run.ID}}"
      - "{{.Run.Registry}}/hmcts/cmc-ccd-definition-importer:{{.Values.TAG}}"
    when:
      - test
